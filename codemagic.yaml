# codemagic.yaml
workflows:
  build-flutter-ios-app:
    name: Build Flutter iOS App
    instance_type: mac_mini_m2
    max_build_duration: 90 # Increased timeout just in case

    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $FCI_BUILD_DIR/ios/Pods

    scripts:
      - name: Get Flutter dependencies
        script: | 
          flutter pub get
      
      # --- FINAL AND MOST AGGRESSIVE FIX ---
      - name: Prepare iOS Podfile
        script: | 
          set -e # Exit immediately if a command fails
          PODFILE_PATH="ios/Podfile"

          echo "--- Podfile before modification ---"
          cat $PODFILE_PATH
          echo "-----------------------------------"

          # Use a Ruby script to perform multiple, reliable edits.
          ruby -e "
          content = File.read('$PODFILE_PATH')

          # 1. Set platform to iOS 13.0
          content.gsub!(/# platform :ios, '12.0'/, 'platform :ios, \\'13.0\\'')
          content.gsub!(/# platform :ios, '11.0'/, 'platform :ios, \\'13.0\\'') # Also catch 11.0

          # 2. THE KEY FIX: Comment out use_frameworks! if it exists.
          content.gsub!(/use_frameworks!/, '# use_frameworks!')

          # 3. As a safeguard, ensure the CLANG setting is in the post_install hook.
          post_install_hook = 'post_install do |installer|'
          clang_setting = \"  installer.pods_project.targets.each do |target|\\n    flutter_additional_ios_build_settings(target)\\n    target.build_configurations.each do |config|\\n      config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'\\n    end\\n  end\"
          content.gsub!(/post_install do \|installer\|/, \"#{post_install_hook}\\n#{clang_setting}\")
          
          File.write('$PODFILE_PATH', content)
          "

          echo "--- Podfile after modification ---"
          cat $PODFILE_PATH
          echo "----------------------------------"

      - name: Install CocoaPods dependencies
        script: | 
          cd ios
          # Force a de-integration and re-integration of pods to be safe
          pod deintegrate
          pod install --repo-update

      - name: Build Flutter iOS app
        script: | 
          flutter build ios --no-codesign
          
    artifacts:
      - build/ios/iphoneos/Runner.app