# codemagic.yaml
workflows:
  build-flutter-ios-app:
    name: Build Flutter iOS App
    instance_type: mac_mini_m2
    max_build_duration: 60

    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $FCI_BUILD_DIR/ios/Pods

    scripts:
      - name: Get Flutter dependencies
        script: | 
          flutter pub get
      
      # --- FIX IS HERE ---
      - name: Set iOS deployment target
        script: | 
          # This command finds the commented-out platform line in the Podfile
          # and replaces it with an uncommented line setting the platform to iOS 13.0.
          # This is necessary for modern Firebase SDKs.
          sed -i.bak "s/# platform :ios, '12.0'/platform :ios, '13.0'/" ios/Podfile
          
      - name: Install CocoaPods dependencies
        script: | 
          cd ios
          pod install

      - name: Build Flutter iOS app
        script: | 
          flutter build ios --no-codesign
          
    artifacts:
      - build/ios/iphoneos/Runner.app